<%@ page language="java" contentType="text/html; charset=EUC-KR"
    pageEncoding="EUC-KR"%>
    
<%@ page import ="java.sql.*,javax.sql.*,javax.naming.*" %>
<%@ page import= "java.text.SimpleDateFormat" %>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>방명록</title>
<meta http-equiv="Content-Type" content="text/html; charset=euc-kr">
<link href="../css/style.css" rel="stylesheet" type="text/css">
</head>
<% 
request.setCharacterEncoding("euc-kr");	
	response.setCharacterEncoding("euc-kr");
	
	String query_count="select count(*) from guestbook";
	String query_list="select *from (select rownum rseq,seq,name,email,homepage,subject,content,logtime from guestbook where rownum<=?) A where A.rseq > ? order by logtime desc";

	int pageSize = 5;
	int cpage=1;
	int total=0;
	
	SimpleDateFormat sdf=new SimpleDateFormat("yyyy-MM-dd hh:mm:ss");
	
	try{
		cpage= Integer.parseInt(request.getParameter("pg"));
		
	}catch(Exception e){
		cpage=1;
	}
	Context initCtx=new InitialContext();
	Context envCtx=(Context)initCtx.lookup("java:comp/env");
	DataSource ds=(DataSource)envCtx.lookup("jdbc/oraclePool");
	Connection conn=null;
	PreparedStatement pstmt= null;
	ResultSet rs=null;
	
	try{
		conn=ds.getConnection();
		pstmt=conn.prepareStatement(query_count);
		rs=pstmt.executeQuery();
		if(rs.next()){
			
			total=rs.getInt(1);
		}
		rs.close();
		pstmt.close();
		%>
		

<body>
<div align="center">
  <!-- 방명록 헤더 -->
  <table width="85%" border="0" cellpadding="0" cellspacing="0">
    <tr>
      <td class="header">방명록</td>
    </tr>
  </table>
  
  <br>
  <table width="85%">
  	<tr>
  		<td>&nbsp;</td>
  		<td align="right">
  			<a href="write.jsp">글쓰기</a>
  		</td>
  		
  	</tr>
  
  </table>
  <!--  방명록 표시 -->
  <table width="85%" border="0" cellspacing="0" cellpadding="0">
  <%
  	int endNo=pageSize * cpage;
    pstmt=conn.prepareStatement(query_list);
    pstmt.setInt(1, endNo);
    pstmt.setInt(2, endNo-pageSize);
    rs=pstmt.executeQuery();
    
    while(rs.next()){

  %>
  
    <tr>
      <td height="20" class="title">작성자: <%=rs.getString("name") %> 
      <%if(rs.getString("email")!=null) {%>
        <a href="mailto:<%=rs.getString("email")%>">
        <img src="/../img/email.gif" alt="이메일" width="24" height="24" border="0" align="absbottom"></a><%} %>
        
        <%if(rs.getString("homepage")!=null) { %>
        
        <a href="<%=rs.getString("homepage")%>"><img src="../../images/homepage.gif" alt="홈페이지" width="14" height="14" border="0" align="absbottom"></a></td>
    	<%} %>
    </tr>
    <tr>
    	
      <td class="content">
      <b><%=rs.getString("subject") %></b><br>
      <%=rs.getString("content") %><br>
      <p class="content" align="right"><%=sdf.format(rs.getTimestamp("logtime")) %></p>
		</td>
    </tr>
    <tr>
      <td align="right">
      <a href="password.jsp?seq=<%=rs.getInt("seq")%>">삭제
      </a></td>
    </tr>
    
    <%
    
    }//end of while
    
    %>
   
  </table>
  
  <%
	}catch(Exception e){
		e.printStackTrace();
	}finally{
		if(conn!=null)conn.close();
	}
	
	
	%>
  <!--  page 표시 -->
  <table width="85%" border="0" cellpadding="0" cellspacing="0">
    <tr>
      <td align="center" class="page"><%
    int totalPage = (total-1)/pageSize + 1;
    int prev10 = (int)Math.floor((cpage-1) / 10.0) * 10;
    int next10 = prev10 + 11;
%>
  <table width="85%" border="0" cellpadding="0" cellspacing="0">
    <tr>
      <td align="center" class="page">
<a href="list.jsp?pg=1">top</a>
<%
    if (prev10 > 0) {
%>
	<a href="list.jsp?pg=<%= prev10 %>">이전</a><%
    }

    for (int i=1+prev10; i< next10 && i<=totalPage; i++ ) {
    	if (i==cpage) {
%> 
	[<b><%= i %></b>]

<%
    	} else {
%> 
	[<a href="list.jsp?pg=<%= i %>"><%= i %></a>]
<%
    	} 
    } // end for

    if (totalPage >= next10) {
%> 
	<a href="list.jsp?pg=<%= next10 %>">다음</a>
<%
    } 
%>
<a href="list.jsp?pg=<%= totalPage %>">bottom</a></td>
    
    </tr>
  </table>
</div>
</body>

</html>
